<!DOCTYPE html>
<html>
  <head>
    <title>Cybertruslen</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=770" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="scripts/game_loop.js"></script>
    <script src="scripts/stage.js"></script>
    <link href="styles/screen.css" rel="stylesheet" type="text/css" />
  </head>

  <body>

    <div id="stage" class="stage">
      <div id="defenders" class="defenders"></div>
    </div>

    <script>
      function Attacker() {
        var self = this;

        this.alive = true;
        this.x = undefined;
        this.y = undefined;
        this.speed = 5;
        this.outlet = undefined;

        this.draw = function() {
          var outlet = this.outlet;
          outlet.style.left = '' + this.x + 'px';
          outlet.style.top = '' + this.y + 'px';
        };

        this.detectWin = function() {
          if (this.checkXPos() && this.checkYPos()) {
            return true;
          }
        };

        this.checkXPos = function() {
          if (this.x > 349 && this.x < 351) {
            return true;
          }
        }

        this.checkYPos = function() {
          if (this.y > 224 && this.y < 226) {
            return true;
          }
        }

        this.moveTowards = function(x, y) {
          var deltaX = x - this.x;
          var deltaY = y - this.y;

          var angle = Math.atan2(deltaY, deltaX);
          this.x += Math.cos(angle) * this.speed;
          this.y += Math.sin(angle) * this.speed;
        }
      }

      function Missile() {
        var self = this;

        this.x = undefined;
        this.y = undefined;
        this.accelleration = 0.2;
        this.speed = 0;
        this.maxSpeed = 15;
        this.target = undefined;
        this.outlet = undefined;
        this.angle = - Math.PI/2;
        this.turnSpeed = 0.15

        this.aquireTarget = function() {
          this.target = scene.attackers[0];
        };

        this.despawn = function() {
          scene.removeMissile(this);
        };

        this.draw = function() {
          var outlet = this.outlet;
          outlet.style.left = '' + this.x + 'px';
          outlet.style.top = '' + this.y + 'px';
        };

        this.update = function() {
          if (this.target && this.target.alive) {
            var deltaX = this.target.x - this.x;
            var deltaY = this.target.y - this.y;
            var targetAngle = Math.atan2(deltaY, deltaX);
            if (targetAngle < -Math.PI) {
              targetAngle += Math.PI
            };
            if (targetAngle > Math.PI) {
              targetAngle -= Math.PI
            };
            if (targetAngle > this.angle) {
              this.angle += this.turnSpeed;
            } else if (targetAngle < this.angle) {
              this.angle -=this.turnSpeed;
            };
          } else {
            this.aquireTarget()
            // No target
          }

          // Out of bounds?
          if (
              (this.x < 0 || this.x > scene.width()) ||
              (this.y < 0 || this.y > scene.height())
            ) {
            this.despawn()
          }

          if (this.speed < this.maxSpeed) {
            this.speed += this.accelleration;
          }

          this.x += Math.cos(this.angle) * this.speed;
          this.y += Math.sin(this.angle) * this.speed;
        };

        this.moveTowards = function(x, y) {
          var deltaX = x - this.x;
          var deltaY = y - this.y;

          var angle = Math.atan2(deltaY, deltaX);
          this.x += Math.cos(angle) * this.speed;
          this.y += Math.sin(angle) * this.speed;
        }
      }
      Missile.spawn = function(x, y) {
        var missile = new Missile();

        missile.x = x;
        missile.y = y;

        missile.aquireTarget();

        return missile;
      };

      function Scene() {
        this.attackers = [];
        this.lost = false;
        this.missiles = [];

        var timestamp = 0;
        var timeBetweenAttackers = 2;
        var timeSinceLastAttacker = 0;

        var difficultyRampUp = 0.95;
        var minimumTimeBetweenAttackers = 0.2;

        this.addAttackerToStage = function(attacker) {
          var attackerElement = document.createElement('div');
          attackerElement.setAttribute("class", "attacker");
          attacker.outlet = attackerElement;
          this.stageElement().appendChild(attackerElement);
        };

        this.addMissileToStage = function(missile) {
          var missileElement = document.createElement('div');
          missileElement.setAttribute("class", "missile");
          missile.outlet = missileElement;
          this.stageElement().appendChild(missileElement);
        };

        this.centerX = function() {
          return this.width() / 2;
        };

        this.centerY = function() {
          return this.height() / 2;
        };

        this.defend = function() {
          this.fireMissile();
        };

        this.defenders = function() {
          return document.getElementById("defenders");
        };

        this.distance = function(a, b) {
          if (!a || !b) {
            return undefined
          }

          var deltaX = a.x - b.x;
          var deltaY = a.y - b.y;

          return Math.sqrt(deltaX*deltaX + deltaY*deltaY);
        }

        this.endGame = function() {
          this.removeAttackersFromStage();
          this.removeAttackers();
          this.timestamp = 0;
          this.timeSinceLastAttacker = 0;
          this.lost = true;
        };

        this.height = function() {
          return $(this.stageElement()).height()
        };

        this.render = function(context, deltaTime) {
          for (var i = 0; i < this.attackers.length; i++) {
            var attacker = this.attackers[i];
            attacker.draw();
            if (attacker.detectWin() == true) {
              this.endGame();
            };
          }

          for (var i = 0; i < this.missiles.length; i++) {
            var missile = this.missiles[i];
            missile.draw();
          }
        };

        this.removeAttacker = function(attacker) {
          var index = this.attackers.indexOf(attacker);
          if (index > -1) {
            this.attackers.splice(index, 1);
          };
          this.removeAttackerFromStage(attacker);
        }

        this.removeAttackers = function() {
          for (var i = 0; i < this.attackers.length; i++) {
            var attacker = this.attackers[i];
            this.removeAttacker(attacker);
          };
        }

        this.removeAttackerFromStage = function(attacker) {
          if (attacker.outlet) {
            $(attacker.outlet).remove();
          }
        }

        this.removeAttackersFromStage = function() {
          var attackersToRemove = this.stageElement().getElementsByClassName("attacker");
          for (var i = 0; i < attackersToRemove.length; i++) {
            this.stageElement().removeChild(attackersToRemove[i]);
          };
        }

        this.removeMissile = function(missile) {
          var index = this.missiles.indexOf(missile);
          if (index > -1) {
            this.missiles.splice(index, 1);
          };
          $(missile.outlet).remove();
        }

        this.spawnAttacker = function() {
          var attacker = new Attacker();
          var angle = Math.random() * Math.PI * 2;
          attacker.x = this.width() / 2 + Math.cos(angle) * this.width()/2;
          attacker.y = this.height() / 2 + Math.sin(angle) * this.height()/2;

          this.attackers.push(attacker);
          this.addAttackerToStage(attacker);
        };

        this.fireMissile = function() {
          var missile = Missile.spawn(this.centerX(), this.centerY());
          if (missile.target) {
            this.missiles.push(missile);
            this.addMissileToStage(missile);
          }
        };

        this.stageElement = function() {
          if (!this._stageElement) {
            this._stageElement = document.getElementById('stage');
          };
          return this._stageElement;
        };

        this.update = function(step) {
          timestamp += step;
          timeSinceLastAttacker += step;

          if (timeSinceLastAttacker > timeBetweenAttackers) {
            this.spawnAttacker();
            timeSinceLastAttacker = 0;
            timeBetweenAttackers = timeBetweenAttackers * difficultyRampUp;
            if (timeBetweenAttackers <= minimumTimeBetweenAttackers) {
              timeBetweenAttackers = minimumTimeBetweenAttackers;
            }
          };

          this.updateMissiles(step);
          this.updateAttackers(step);
        };

        this.updateAttackers = function(step) {
          for (var i = 0; i < this.attackers.length; i++) {
            var attacker = this.attackers[i];
            attacker.moveTowards(
              this.width() / 2,
              this.height() / 2
            );
          }
        };

        this.updateMissiles = function(step) {
          for (var i = 0; i < this.missiles.length; i++) {
            var missile = this.missiles[i];
            missile.update();

            var distanceToTarget = this.distance(missile, missile.target);
            if (distanceToTarget < 15) {
              missile.target.alive = false;
              this.removeAttacker(missile.target)
              this.removeMissile(missile)
            }
          }
        };

        this.width = function() {
          return $(this.stageElement()).width()
        };
      }

      var stage = new Stage();
      var scene = new Scene();
      stage.play(scene);

      function handleKey(event){
        switch (event.keyCode) {
          case 13:
            /* enter key was pressed */
            scene.defend();
            break;
        }
      }
      window.addEventListener('keyup', handleKey, true);
    </script>
  </body>
</html>
