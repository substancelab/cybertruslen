<!DOCTYPE html>
<html>
  <head>
    <title>Cybertruslen</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=770" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="scripts/game_loop.js"></script>
    <script src="scripts/stage.js"></script>
    <link href="styles/screen.css" rel="stylesheet" type="text/css" />
  </head>

  <body>

    <div id="stage" class="stage">
      <div id="defenders" class="defenders"></div>
    </div>

    <script>
      function Attacker() {
        var self = this;

        this.x = 100;
        this.y = 100;
        this.speed = 5;
        this.outlet = undefined;

        this.draw = function() {
          var outlet = this.outlet;
          outlet.style.left = '' + this.x + 'px';
          outlet.style.top = '' + this.y + 'px';
        };

        this.detectWin = function() {
          if (this.checkXPos() && this.checkYPos()) {
            return true;
          }
        };

        this.checkXPos = function() {
          if (this.x > 349 && this.x < 351) {
            return true;
          }
        }

        this.checkYPos = function() {
          if (this.y > 224 && this.y < 226) {
            return true;
          }
        }

        this.moveTowards = function(x, y) {
          var deltaX = x - this.x;
          var deltaY = y - this.y;

          var angle = Math.atan2(deltaY, deltaX);
          this.x += Math.cos(angle) * this.speed;
          this.y += Math.sin(angle) * this.speed;
        }
      }

      function Scene() {
        this.attackers = [];
        this.lost = false;

        var timestamp = 0;
        var timeSinceLastAttacker = 0;

        this.addAttackerToStage = function(attacker) {
          var attackerElement = document.createElement('div');
          attackerElement.setAttribute("class", "attacker");
          attacker.outlet = attackerElement;
          this.stageElement().appendChild(attackerElement);
        };

        this.removeAttackersFromStage = function() {
          var attackersToRemove = this.stageElement().getElementsByClassName("attacker");
          for (var i = 0; i < attackersToRemove.length; i++) {
            this.stageElement().removeChild(attackersToRemove[i]);
          };
        }

        this.endGame = function() {
          this.removeAttackersFromStage();
          this.removeAttackers();
          this.timestamp = 0;
          this.timeSinceLastAttacker = 0;
          this.lost = true;

        this.centerX = function() {
          this.width / 2;
        };

        this.centerY = function() {
          this.height / 2;
        };

        this.defenders = function() {
          return document.getElementById("defenders");
        };

        this.height = function() {
          return $(this.stageElement()).height()
        };

        this.render = function(context, deltaTime) {
          for (var i = 0; i < this.attackers.length; i++) {
            var attacker = this.attackers[i];
            attacker.draw();
            if (attacker.detectWin() == true) {
              this.endGame();
            };
          }
        };

        this.removeAttackers = function() {
          for (var i = 0; i < this.attackers.length; i++) {
            var index = this.attackers[i];
            if (index > -1) {
              this.attackers.splice(index, 1);
            }
          };
        }

        this.spawnAttacker = function(step) {
          var attacker = new Attacker();
          var angle = Math.random() * Math.PI * 2;
          attacker.x = this.width() / 2 + Math.cos(angle) * this.width();
          attacker.y = this.height() / 2 + Math.sin(angle) * this.height();


          // console.log(attacker)
          this.attackers.push(attacker);
          this.addAttackerToStage(attacker);
        };

        this.stageElement = function() {
          if (!this._stageElement) {
            this._stageElement = document.getElementById('stage');
          };
          return this._stageElement;
        };

        this.update = function(step) {
          timestamp += step;
          timeSinceLastAttacker += step;
          if (timeSinceLastAttacker > 1) {
            this.spawnAttacker();
            timeSinceLastAttacker = 0;
          };

          this.updateAttackers(step);
        };

        this.updateAttackers = function(step) {
          for (var i = 0; i < this.attackers.length; i++) {
            var attacker = this.attackers[i];
            attacker.moveTowards(
              this.width() / 2,
              this.height() / 2
            );
          }
        };

        this.width = function() {
          return $(this.stageElement()).width()
        };
      }

      var stage = new Stage();
      var scene = new Scene();
      stage.play(scene);

      function doKeyDown(event){
        switch (event.keyCode) {
          case 13:
            /* enter key was pressed */
            console.log('DEFEND')
            break;
        }
      }
      window.addEventListener('keydown', doKeyDown, true);
    </script>
  </body>
</html>
